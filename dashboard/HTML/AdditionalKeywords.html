{% include 'additional-keywords-component.html' %}
<style>
    .ADDITIONAL-KEYWORDS_root{
        height           :70%;
        width            :100%;
        max-width        :526px ;
        background-color :white;
        padding          :10 10 10 10;
        display          :none;
        flex-direction   :column ;
    }
    .ADDITIONAL-KEYWORDS_kwords-container{        
        flex-grow        :1;  
        display          :flex;
        flex-direction   :column;
        overflow-y       : auto ;
    }
</style>    
<div id='ADDITIONAL-KEYWORDS::root' class='ADDITIONAL-KEYWORDS_root tw_Ctrl-Group'>
    <div class='tw_h3' style='position:relative;margin-bottom:20px;'>Additional Keywords</div>

    <div id='ADDITIONAL-KEYWORDS::add-kword-dialog' style='position:absolute; right:30px; z-index:3; border:2px solid black; display:none; flex-direction: column;
        background-color:white; padding:10 10 10 10; width:600px; gap:10px; border-radius: 12px;' name='DASHBOARD::hide-me'>
        <h3 class='tw_h3' style='margin-bottom:20px'>Add external keyword</h3>
        <input id='ADDITIONAL-KEYWORDS::kword-kword' type='text' class='tw_input' placeholder='keyword' style='border:none; border-bottom:1px solid lightgray;'></input>      
        <input id='ADDITIONAL-KEYWORDS::url' type='text' class='tw_input' placeholder='target url' style='border:none; border-bottom:1px solid lightgray;'></input>          
        <div style='display:flex;flex-direction:row-reverse;'>
            <button id='ADDITIONAL-KEYWORDS::add-link-dialog-button' class='tw_button-alt'>Add</button>
        </div>
    </div>

    <div id='ADDITIONAL-KEYWORDS::kwords-container' class='ADDITIONAL-KEYWORDS_kwords-container'></div>
    <div style='display:flex;flex-direction:row-reverse;gap:6px'>
        <button id='ADDITIONAL-KEYWORDS::add-kword-button' class='tw_button-alt' name="DASHBOARD_tool-tip">Add external keyword</button>
        <button id='ADDITIONAL-KEYWORDS::import' class='tw_button-alt' style='width:90px'>                 
            <svg xmlns="http://www.w3.org/2000/svg" class="KEYWORDS_gdoc-all" viewBox="0 0 512 512" style="fill:black">
                <path d="M128 64c0-35.3 28.7-64 64-64H352V128c0 17.7 14.3 32 32 32H512V448c0 35.3-28.7 64-64 64H192c-35.3 0-64-28.7-64-64V336H302.1l-39 39c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0l80-80c9.4-9.4 9.4-24.6 0-33.9l-80-80c-9.4-9.4-24.6-9.4-33.9 0s-9.4 24.6 0 33.9l39 39H128V64zm0 224v48H24c-13.3 0-24-10.7-24-24s10.7-24 24-24H128zM512 128H384V0L512 128z"/>
            </svg>
        </button>  
    </div>
</div> 

<script> 
    async function ADDITIONAL_KEYWORDS_GetPermalinkFromJson(json, kword){
        let url       = kword['BaseURL']
        let permalink =  ''  
        while (url.endsWith('\\') || url.endsWith('/')){
            url = url.substring(0, url.length - 1);
        }         
        if (url == '') {
            url = json['KEYWORDS_BaseURL']
            while (url.endsWith('\\') || url.endsWith('/')){
                url = url.substring(0, url.length - 1);
            }    
            return `${url}/${kword.Keyword.replaceAll(' ', '-')}${CLUSTERCREATOR_SETTINGS.GetURLTerminator()}`;
        } return `${url}/${kword.Keyword.replaceAll(' ', '-')}${CLUSTERCREATOR_SETTINGS.GetURLTerminator()}`;    
    }
    document.getElementById('ADDITIONAL-KEYWORDS::add-kword-dialog').onclick = function(event){event.stopPropagation()};
    document.getElementById('ADDITIONAL-KEYWORDS::add-kword-button').onclick = function(event){
        event.stopPropagation();
        document.getElementById('ADDITIONAL-KEYWORDS::add-kword-dialog').style.display = 'flex';        
    }
    document.getElementById('ADDITIONAL-KEYWORDS::add-link-dialog-button').onclick = function(){
        ADDITIONAL_KEYWORDS.AddKword()
    }
    document.getElementById('ADDITIONAL-KEYWORDS::import').onclick = function(){
        DASHBOARD_Load(async function(data){
            await DASHBOARD_UpdateSettings()
            let json = JSON.parse(data);
            if (false == 'Keywords' in json){
                return alert('No keywords found in the file')
            }
            for (const kword of json.Keywords){
                let k   = kword.Keyword;
                let url = await ADDITIONAL_KEYWORDS_GetPermalinkFromJson(json, kword);
                ADDITIONAL_KEYWORDS.AddKwordB(k, url, kword.Anchors)                
            }
        }, accept = '.json')
    }
    var ADDITIONAL_KEYWORDS = {
        __kwords : {},
        GetKeyWord(kword){
            return kword in this.__kwords;
        },
        ListKeywords(){
            let kwords = [];
            for (const [key, value] of Object.entries(this.__kwords)){
                kwords.push(key);
            }
            return kwords;
        },
        ToJson(){
            let kwords = []
            for (const [key, value] of Object.entries(this.__kwords)){
                kwords.push({
                    Keyword       : key,
                    URL           : value.Url,
                    Anchors       : value.Anchors.Selection(),
                    'Core entity' : value.CoreEntityInput.value
                })
            }
            return kwords
        },
        FromJson(json){
            this.__kwords = {};
            let children  = [];            
            for (const child of document.getElementById('ADDITIONAL-KEYWORDS::kwords-container').children){
                children.push(child);
            }
            for (const child of children){
                child.parentElement.removeChild(child)
            }
            if (false === ('Additional Keywords' in json)) return;            
            for (const kword of json['Additional Keywords']){
                this.__AddKword(kword.Keyword, kword.URL, kword['Core entity'], kword.Anchors)
            }
        },
        KeyWordURL(kword){
            if (kword in this.__kwords){
                return this.__kwords[kword].Url
            }
            return `Url for keyword "${kword}" not found`
        },
        RemoveKeyword(kword){
            delete this.__kwords[kword];
        },
        NextAnchorForKeyword(kword){
            if (false === (kword in this.__kwords)) return `${kword} is not an additional keyword`;   
            let k = this.__kwords[kword]
            if (k.Anchors.Selection().length == 0){
                    return `No anchors for ${kword}`
                }
            k.AnchorIndex += 1
            if (k.AnchorIndex >k.Anchors.Selection().length-1){
                k.AnchorIndex = 0;
            } 
            return k.Anchors.Selection()[k.AnchorIndex];         
        },
        GetAnchorForKeyword(kword){
            if (false === (kword in this.__kwords)) return null;   
            return this.__kwords[kword].Anchors.Selection()
        },
        __AddKword(kword, url, core_entity='', anchors_list=[]){
            let entity_label          = document.createElement('div');
            let entity_input          = DASHBOARD_AziaForm('input', 'Core entity', 'border:none; border-bottom:1px solid lightgray; height:30px;');      
            let anchors               = DASHBOARD_Multichoice([]);   
            this.__kwords[kword]      = {'Url' : url, 'Anchors' : anchors, 'AnchorIndex' : 0, 'CoreEntityInput' : entity_input};
            let kwords_container      = document.getElementById('ADDITIONAL-KEYWORDS::kwords-container');
            let kword_container       = document.createElement('div');
            let kword_label           = document.createElement('div');
            let anchors_label         = document.createElement('div');
            let addanchor_label       = document.createElement('div');
            let addanchor_input       = DASHBOARD_AziaForm('input', 'Type the anchor text and hit enter', 'border:none; border-bottom:1px solid lightgray; height:30px;');                          
            let buttons_div           = document.createElement('div');
            entity_input.value        = core_entity;
            buttons_div.style         = 'display:flex;flex-direction:row-reverse;margin-top:2px';
            anchors_label.innerHTML   = 'Anchors';
            entity_label.innerHTML    = 'Core entity';
            addanchor_label.innerHTML = 'Add anchor';
            kword_label.innerHTML     = `<b>${kword}</b> <div class='DASHBOARD_ClicableText DASHBOARD_ellipsis'>URL: ${url}</div>`;  
            kword_label.style         = 'border-top: 1px solid black; display:flex;flex-direction:column;margin-bottom:10px';      
            kword_label.className     = 'tw_h3_5 DASHBOARD_ellipsis';  
            kword_container.style     = 'display:flex; gap:2px; flex-direction:column;margin-bottom:16px';
            addanchor_label.className = 'tw_h4';
            anchors_label.className   = 'tw_h4';
            entity_label.className    = 'tw_h4';
            if (core_entity !== '') entity_label.innerHTML = core_entity
            for (const anchor of anchors_list){
                anchors.AddOption(anchor)
            }
            kword_container.appendChild(kword_label);
            kword_container.appendChild(anchors_label);
            kword_container.appendChild(anchors.Container());
            kword_container.appendChild(addanchor_label);
            kword_container.appendChild(addanchor_input);
            kword_container.appendChild(entity_label);
            kword_container.appendChild(entity_input);
            kword_container.appendChild(buttons_div);            
            buttons_div.innerHTML += '<svg xmlns="http://www.w3.org/2000/svg" class="tw_Icon-Clickable tw_icon-medium-large" viewBox="0 0 576 512"><path d="M320 96a32 32 0 1 1 -64 0 32 32 0 1 1 64 0zm21.1 80C367 158.8 384 129.4 384 96c0-53-43-96-96-96s-96 43-96 96c0 33.4 17 62.8 42.9 80H224c-17.7 0-32 14.3-32 32s14.3 32 32 32h32V448H208c-53 0-96-43-96-96v-6.1l7 7c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9L97 263c-9.4-9.4-24.6-9.4-33.9 0L7 319c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0l7-7V352c0 88.4 71.6 160 160 160h80 80c88.4 0 160-71.6 160-160v-6.1l7 7c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-56-56c-9.4-9.4-24.6-9.4-33.9 0l-56 56c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0l7-7V352c0 53-43 96-96 96H320V240h32c17.7 0 32-14.3 32-32s-14.3-32-32-32H341.1z"/></svg>'
            buttons_div.innerHTML += '<svg xmlns="http://www.w3.org/2000/svg" class="tw_Icon-Clickable tw_icon-medium-large" viewBox="0 0 448 512"><path d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z"/></svg>'
            kwords_container.appendChild(kword_container);
            addanchor_input.onkeypress = function(event) {
                if (event.key === 'Enter'){                                            
                    anchors.AddOption(addanchor_input.value)
                    addanchor_input.value = '';
                }      
            }
            buttons_div.children[1].onclick = function(){
                ADDITIONAL_KEYWORDS.RemoveKeyword(kword);
                kword_container.parentElement.removeChild(kword_container);
            };
            buttons_div.children[0].onclick = async function(){
                if (entity_input.value == ""){
                    alert("Please provide a core entity")
                    return
                }
                await DASHBOARD_UpdateSettings()
                CLUSTERCREATOR_msg(`Generating anchors for external keyword ${kword}`);
                var fetch_options  = DASHBOARD_FetchOPtions()  
                var options        = {Keyword : kword, CoreEntity : entity_input.value, Anchors : anchors.Selection(), Model : DASHBOARD_GetModel('anchors')}
                fetch_options.body = JSON.stringify({Request : [options]});    
                var reply          = await DASHBOARD_Fetch('/cluster_creator-anchors', fetch_options);
                reply              = reply.Reply[0];                   
                for (anchor of reply.Anchors){
                    anchors.AddOption(anchor)
                }                 
                CLUSTERCREATOR_msg('', 'Done generating anchors');   
            };
            kword_label.children[1].onclick = function(){
                window.open(kword_label.children[1].innerHTML.split('URL: ')[1])
            }
        },
        AddKwordB(kword, url, anchors){
            if (kword in this.__kwords){
                alert(`'${kword}' is already an additional keyword`);
                return;
            }
            if (KEYWORDS.GetKeyWord(kword)){
                alert(`'${kword}' is already a keyword`);
                return;
            }
            this.__AddKword(kword, url, '', anchors)  
        },
        AddKword(){
            let kword =  document.getElementById('ADDITIONAL-KEYWORDS::kword-kword').value;
            let url   =  document.getElementById('ADDITIONAL-KEYWORDS::url').value;
            if (kword === '') return alert('Empty keyword');
            if (url   === '') return alert('Empty url');
            document.getElementById('ADDITIONAL-KEYWORDS::add-kword-dialog').style.display = 'none';   
            if (kword in this.__kwords){
                alert(`'${kword}' is already an additional keyword`);
                return;
            }
            if (KEYWORDS.GetKeyWord(kword)){
                alert(`'${kword}' is already a keyword`);
                return;
            }
            this.__AddKword(kword, url)  
        }
    }
    function __ADDITIONAL_KEYWORDS(_this, top){
        let input_val = ''
        this.Changed = (input)=>{
            input_val = input.value
        }
        this.cliked = ()=>{
            alert(input_val)
        }
        this.html = /*html*/`
        <div class="tw_dialog-container" style="display:flex;flex-direction:column;gap:10px;top:${top};margin:0px">
            <div class="tw_Ctrl-Group tw_dialog" style="margin:0px">
                <input type="text" class="tw_input" onchange="${_this}.Changed(this)">
                <button class="tw_button-alt" onclick="${_this}.cliked()">Add</button>
            </div>
        </div>`
        return this
    }
    let f = new __ADDITIONAL_KEYWORDS("f", "40px")
    let g = new __ADDITIONAL_KEYWORDS("g", "120px")
    //document.body.insertAdjacentHTML('beforeend', f.html);
    //document.body.insertAdjacentHTML('beforeend', g.html);

    function ADITIONAL_KEYWORD_FormatKeywordForUrl(keyword){
        let blacklists = DASHBOARD_OptionO("BlackLists")
        let kword      = keyword.replaceAll(' ', '-');
        if ('Stop Words' in blacklists) {
            for (let word of blacklists['Stop Words']) {
                kword = kword.replaceAll(`-${word}`, '')                       
            }
        }
        return kword
    }

    var ADDITIONAL_KEYWORDS_V2 = {
        __kwords : {},
        __keep   : null,
        FromJson(json){
            this.__kwords = {};
            if (false === ('Additional Keywords' in json)) return;            
            for (const kword of json['Additional Keywords']){                
                this.__kwords[kword.Keyword] = {"Url" : kword.URL, "Anchors" : kword.Anchors, "CoreEntity" : kword['Core entity'], "AnchorIndex" : 0}
            }
        },
        SetKeeppers(keepers){
            if (keepers === undefined) keepers = null;
            this.__keep = keepers
        },
        GetKeeppers(){
            return this.__keep
        },
        KeyWordURL(kword){
            for (let obj of [ADDITIONAL_KEYWORDS_V2, DOMAIN_KEYWORS_V2, DOMAIN_OWNED_KEYWORS]){
                if (kword in obj.__kwords){
                    if ('Url' in obj.__kwords[kword]){    
                        /*          
                        if (true === ('DontAppendKword' in obj.__kwords[kword])) {  // Its a sibling keyword
                            url = obj.__kwords[kword].Url
                            if (true === obj.__kwords[kword].DontAppendKword || 'true' === String(obj.__kwords[kword].DontAppendKword).toLowerCase()) 
                            return `${url}${CLUSTERCREATOR_SETTINGS.GetURLTerminator()}`;       
                            return `${url}/${ADITIONAL_KEYWORD_FormatKeywordForUrl(kword)}${CLUSTERCREATOR_SETTINGS.GetURLTerminator()}`;               
                        }*/
                        return obj.__kwords[kword].Url
                    }
                }
            }
            //alert( `Url for keyword "${kword}" not found`);
            return `Url for keyword "${kword}" not found`
        },
        async Edit(){
            if (KEYWORDS.GetClient() != ''){
                alert("Domain Clusters don't hace clusters owned additinal keywords");
                return
            }
            let elements = await AdditionalKeywordsComponent(async() => {
                console.log("========================================", this.__kwords)
                return this.__kwords
            })
            console.log(elements)
            elements.container.style.zIndex = 5;
            elements.Commit.onclick = () => {
                let data = JSON.parse(JSON.stringify(elements.Data()));
                console.log(data)
                for (let kword of Object.keys(data)){
                    this.__kwords[kword] = {"Url" : data[kword].Url, "Anchors" : data[kword].Anchors, "CoreEntity" : data[kword].CoreEntity, "AnchorIndex" : 0};
                }
                console.log(this.__kwords)
                alert("Updated")
            }
        },
        ToJson(){
            let kwords = []
            for (const [key, value] of Object.entries(this.__kwords)){
                kwords.push({"Keyword" : key, "URL" : value.Url, "Anchors" : value.Anchors, "Core entity" : value.CoreEntity})
            }
            console.log(kwords)
            return kwords
        },
        GetKeyWord(kword){
            //console.log(kword in Object.keys(this.__kwords), kword, Object.keys(this.__kwords))
            if (kword === 'update') return false
            return Object.keys(this.__kwords).includes(kword)
        },
        ListKeywords(){
            if (this === ADDITIONAL_KEYWORDS_V2 && KEYWORDS.GetClient() != ''){
                return []
            }
            if ('update' in this.__kwords)
                delete this.__kwords['update']; 
            let klist = []
            if (this.__keep !== null) {
                for (let kword of Object.keys(this.__kwords)){
                    if (this.__keep.includes(kword) === false) continue;
                    klist.push(kword)
                }
            } else {
                klist = Object.keys(this.__kwords)
            }
            return klist                      
        },
        NextAnchorForKeyword(kword){
            console.log("=========================================================================")
            console.log(kword, this.__kwords)
            if (kword in this.__kwords){
                this.__kwords[kword].AnchorIndex += 1;
                if (this.__kwords[kword].AnchorIndex >= this.__kwords[kword].Anchors.length) this.__kwords[kword].AnchorIndex = 0;
                return this.__kwords[kword].Anchors[this.__kwords[kword].AnchorIndex];
            }
        },
        GetAnchorsForKeyword(kword){
            if (kword in this.__kwords === false) return NULL;
            return this.__kwords[kword].Anchors
        }
    }
    ADDITIONAL_KEYWORDS = ADDITIONAL_KEYWORDS_V2
</script>
