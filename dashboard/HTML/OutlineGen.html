<style>
    .OUTLINEGEN_Title{
        text-justify: left;
    }
    .OUTLINEGEN_Base-Column{
        display       : flex;
        flex-direction: column;
        height        : 100%;;   
        width         : 100%;                     
    }
    .OUTLINEGEN_SERP-Column{
        display        : flex;
        flex-direction : column;             
        padding-bottom : 4px;
        width          : 100%;
    }
    .OUTLINEGEN_SERP-buttons-column{
        display        : flex;
        flex-direction : column;
        gap            : 8px;
    }
    .OUTLINEGEN_URLS-Row{
        display        : flex;
        flex-direction : row;
        gap            : 10px;      
        border-bottom  : 1px solid lightgray ;   
        padding-bottom  : 10px ;    
    }
    .OUTLINEGEN_URLS-Column{
        display        : flex;
        flex-direction : column;            
        width          : 800px;
        gap            : 0px;
    }
    .OUTLINEGEN_URLS-Base-Column{
        display        : flex;
        flex-direction : column;            
        width          : 100%;  
        flex-grow:1;
        margin: 0 0 0 0;        
    }
    .OUTLINEGEN_Scrape-Button-Column{
        display        : flex;
        flex-direction : column;
        gap            : 8px;
        margin-top     : 4px;   
    }
    .OUTLINEGEN_Scrape-Button{
        width : 300px;   
        font-size: 12px;         
    }
    .OUTLINEGEN_Scrape-ButtonSpacer{
        flex-grow: 1
    }
    .OUTLINEGEN_Outlines-Base-Column{
        display        : flex;
        flex-direction : column;            
        width          : 800px;
        gap            : 2px;        
        visibility     : hidden;           
    }          
</style>   
<div id='OUTLINEGEN::root' class='OUTLINEGEN_Base-Column tw_Groups-Container'>   

    <div style='display:flex; gap:2px'>                    
        <p id='OUTLINEGEN::msg' class='mg-b-20 OUTLINEGEN_Title'></p> 
        <div id='OUTLINEGEN::spinner' class='DASHBOARD_Loader' style='width:26px; height:26px; margin-top:-4px'></div>
    </div>

    {% if page == 'ClusterCreator' %}    
        <div style='display:flex; width:100%; gap:20px; margin-bottom:26px; margin-top:-6px;position:abolute;display:none;'>
            <div style='display:flex;flex-direction:column; width:50%; position:relative'>
                <div class='az-content-label mg-b-5 OUTLINEGEN_Title'>Tones</div>
                <p class='mg-b-20 OUTLINEGEN_Title'>Select two</p>     
                <select id='OUTLINEGEN::tones-container' class="form-control" multiple="multiple" onChange='OutlineGen.ToneChanged()'>
                    <template id='OUTLINEGEN::tone-template'>                                
                        <option value="..."  onmouseenter='OutlineGen.ShowToneTip(this)' 
                        onmouseleave="document.getElementById('OUTLINEGEN::tone-tip').style.display = 'none'">Whatever</option>
                    </template>                  
                </select>  
                <div id='OUTLINEGEN::tone-tip' style='position:absolute; top:150px; display:none; background-color:#6f42c1ff; color:white; width:600px;
                padding:20 20 20 20; word-wrap: normal; z-index:1'>               
                </div>                          
            </div> 
            <div style='display:flex;flex-direction:column; width:50%; position:relative'>
                <div class='az-content-label mg-b-5 OUTLINEGEN_Title'>Audiences</div>
                <p class='mg-b-20 OUTLINEGEN_Title'>Select one</p>         
                <select id='OUTLINEGEN::audiences-container' class="form-control" multiple="multiple" onChange='OutlineGen.AudienceChanged()'>
                    <template id='OUTLINEGEN::audience-template'>                                
                        <option value="..." onmouseenter='OutlineGen.ShowAudienceTip(this)' 
                        onmouseleave="document.getElementById('OUTLINEGEN::audience-tip').style.display = 'none'">Whatever</option>
                    </template>                  
                </select> 
                <div id='OUTLINEGEN::audience-tip' style='position:absolute; top:150px; display:none; background-color:#6f42c1ff; color:white; width:600px;
                padding:20 20 20 20; word-wrap: normal; z-index:1'>               
                </div>
            </div>         
        </div>            
    {% endif %}    
    
    <div id='OUTLINEGEN::URLs-Row' class='OUTLINEGEN_URLS-Row'>         
        <div style='display:flex; margin-top:0px; margin-bottom:10px; gap:20px;'>  
            <div class='tw_Ctrl-Group' >                
                <div class='OUTLINEGEN_SERP-buttons-column' style='width:600px; gap:16px'> 
                    <h3 class='tw_h3' style='margin-bottom:-10px'>Keyword</h3>
                    {% if page == 'OutlineGenPage' %}               
                        <input id='OUTLINEGEN::Keyword' class="tw_input" placeholder='Keyword' type="text"> 
                    {% else %}     
                    <select id='OUTLINEGEN::Keyword' class="tw_input">
                        <option value='PlaceHolder' label="PlaceHolder"></option>                    
                    </select> 
                    {% endif %}      
                    <h3 class='tw_h3' style='margin-bottom:-10px'>Country</h3>             
                    <select id='OUTLINEGEN::Country' class="tw_input">
                        <option value='US' label="United States"></option>                    
                        <option value="CA" data-select2-id="26">Canada</option>
                        <option value="UK" data-select2-id="27">United Kingdom</option>
                        <option value="AU" data-select2-id="28">Australia</option>
                        <option value="NL" data-select2-id="29">Netherlands</option>
                    </select>  
                    <div class='tw_h3' style='display:none;margin-bottom:-10px'>Model</div>                           
                    <select id='OUTLINEGEN::model' class="tw_input" style="width:600px;display:none">            
                        <option value='openai/gpt-4-turbo-preview' label='OpenAI: GPT-4 Turbo (preview)'></option>                          
                    </select>                           
                    <div style='display:flex; gap:10px; margin-top:20px'>       
                        <div style='display:flex;flex-direction:column; gap:10px; width:50%;'>  
                            <h3 class='tw_h3' style='margin-bottom:2px'>Current keyword actions</h3>       
                            <button class="tw_button", onclick='OutlineGen_SERP()'>Scrape SERP</button>  
                            <button id='OUTLINEGEN::scrape' class="tw_button" disabled onclick='OutlineGen.Scrape()'>Extract outlines</button> 
                            <button id='OUTLINEGEN::clean-up-single-button' class="tw_button" disabled onclick='OutlineGen.CleanUP()'>Clean Competitor's Outlines</button> 
                            <button id='OUTLINEGEN::gen-button' class="tw_button" style='display:none' disabled onclick='OutlineGen.Generate()'>Generate Outline - GPT-4 only</button> 
                            <button id='OUTLINEGEN::improve-button' class="tw_button" disabled onclick='OutlineGen.Optimize()'>
                                Generate Outline</button>      
                        </div>  
                        <div style='display:flex;flex-direction:column; gap:10px;; width:50%'>      
                            <h3 class='tw_h3' style='margin-bottom:2px'>All keywords actions</h3>                
                            <button id='OUTLINEGEN::sertp-all' class="tw_button", disabled style='margin:0' onclick='OutlineGen_SERPAll()'>Scrape SERP</button>
                            <button id='OUTLINEGEN::scrape-all' class="tw_button" disabled onclick='OutlineGen.Scrape_All()'>Extract outlines</button> 
                            <button id='OUTLINEGEN::clean-up-button' class="tw_button" disabled onclick='OutlineGen.CleanUP_All()'>Clean Competitor's Outlines</button> 
                            <button id='OUTLINEGEN::improve-button-all' class="tw_button" disabled onclick='OutlineGen.Optimize_All()'>
                                Generate Outlines</button> 
                        </div>          
                    </div>                                                                                                                      
                </div>     
                <div style="display:flex;gap:10px">           
                    <div style="display:flex;flex-direction:column;width:100%">
                        <h3 class='tw_h3' style='margin-bottom:12px;margin-top:20px;'>Prompts</h3>   
                        <div style='display:flex; gap:10px'>        
                            <select id='OUTLINEGEN::prompts' class="tw_input" style="width:100%">                             
                            </select> 
                        </div> 
                    </div>   
                    <div style="display:flex;flex-direction:column;width:100%">
                        <h3 class='tw_h3' style='margin-bottom:12px;margin-top:20px;'>Special intructions</h3>   
                        <textarea id='OUTLINEGEN::special-instructions' class="tw_input" rows="6" style="height:160px"></textarea>
                    </div>   
                </div>  
            </div>           
        </div>           
        <div class='tw_Ctrl-Group' style="height:618px;width:100%"> 
            <h3 class='tw_h3' style='margin:0 0 0 0; margin-bottom:10px'>URLs List</h3>        
            <div id='OUTLINEGEN::URLs-Column' style='height:260px;width:100%; margin: 0 0 0 0;' class='OUTLINEGEN_URLS-Column'></div> 
            <div id='OUTLINEGEN::result' style='display:flex; flex-direction:column; height:300px; width:100%;'>
                <h3 class='tw_h3' style='margin:0 0 0 0; margin-bottom:10px'>AI Outline</h3>                
                <textarea id='OUTLINEGEN::result-view' rows=30 class='tw_input' style='width:100%; height:100%;margin: 0 0 0 0;'>Outline</textarea>  
                <div style='display:flex; flex-direction: row-reverse; margin-top:10px; width:100%; gap:6px'>                               
                    <button class="tw_button" style='width:200px' onclick='OutlineGen.Export()'>Export</button>
                    <button class="tw_button" style='width:200px' onclick='OutlineGen_FixOutLine()'>Fix</button>
                </div>                          
            </div>               
        </div>          
    </div>  

    <div style='min-height:30px'></div>
        <div id='OUTLINEGEN::outlines-subtitle' class='az-content-label mg-b-5 OUTLINEGEN_Title;' style='visibility:hidden'>Scraped outlines</div>
        <p class='mg-b-20 OUTLINEGEN_Title'></p> 
        <div id='OUTLINEGEN::outlines-div' style='display:flex; gap:20px; flex-wrap:wrap;'>     
    </div>   
    <div style='min-height:60px'></div>
</div>   


<script>
    var OutlineGen = {
        __CurrentKeyword   : null,
        __URLs             : [],
        __SeachIntent      : '',
        __TonesIdsList     : [],
        __AudiencesIdsList : [],
        __Tones            : {},
        SetKeyword(kword){
            OUTLINEGEN_ResetView()
            this.__CurrentKeyword = null;
            if (kword == null) return;
            var urls = kword.OutlineWidgetProgress_HasURLs();            
            if (urls == null)  {
                this.__CurrentKeyword = kword;
                return;
            }
            OutlineGen_SERPDone(urls);
            this.SelectURLs(urls.URLsSelection);
            var outlines = kword.OutlineWidgetProgress_HasOutlines();            
            if (outlines == null)  {
                //this.__CurrentKeyword = kword;
                //return;
            }
            else this.ScrapeFinished(outlines);            
            var outline = kword.OutlineWidgetProgress_HasOutline();  
            if (outline == null)  {
                this.__CurrentKeyword = kword;
                return;
            }   
            this.GenerateFinished(outline);
            this.__CurrentKeyword = kword;                
        },
        FromJson(cfg){               
            let slct = document.getElementById('OUTLINEGEN::model') ;  
            if (true === ('Outlines Model' in cfg)) {                
                for (const option of slct.options) {
                    if (option.value === cfg['Outlines Model'])
                    option.selected = true;
                } 
            }
            if (true === ('Outlines Country' in cfg)) {     
                slct = document.getElementById('OUTLINEGEN::Country') ;                
                for (const option of slct.options) {
                    if (option.value === cfg['Outlines Country'])
                    option.selected = true;
                } 
            }
            if (true === 'Outlines Intructions' in cfg) {
                document.getElementById('OUTLINEGEN::special-instructions').value = cfg['Outlines Intructions'];
            }
        },
        ToJson(){
            let json = {'Outlines Model' : '', 'Outlines Country' : '', 
            'Outlines Intructions' : document.getElementById('OUTLINEGEN::special-instructions').value}
            let slct = document.getElementById('OUTLINEGEN::model');                
            for (const option of slct.options) {
                if (option.selected === true) {                    
                    json['Outlines Model'] = option.value;
                }
            }          
            slct = document.getElementById('OUTLINEGEN::Country');    
            for (const option of slct.options) {
                if (option.selected === true) {                    
                    json['Outlines Country'] = option.value;
                }
            }   
            return json;
        },
        __GetCleanUPPrompts(){
            let templates = 
            DASHBOARD_OptionO('More Prompts')['Outlines'][document.getElementById('OUTLINEGEN::prompts').value];
            if (templates.lenght < 5 || templates[4] == '' || templates[3] == ''
                || templates[4] == 'undefined' || templates[3] == 'undefined'
                || templates[4] == undefined   || templates[3] == undefined 
            ) return null;
            return {System : templates[3], User : templates[4]};
        },
        __GetAudience(){
//{% if page == 'ClusterCreator' %}        
            return CLUSTERCREATOR_SETTINGS.GetAudience()
//{% endif %} 
            let aud = DASHBOARD_GetOption('Selected Audience');
            try{
                return aud.Name
            } catch(err){
                return ''
            }
            return DASHBOARD_GetOption('Selected Audience').length > 0 ? DASHBOARD_GetOption('Selected Audience')[0] : ''             
        },        
        __GetTones(){
//{% if page == 'ClusterCreator' %}        
            return CLUSTERCREATOR_SETTINGS.GetTones()
//{% endif %} 
            let tones = DASHBOARD_GetOption('Selected Tones');
            let ret   = []
            for (tone of tones){
                ret.push(tone.Name)
            }
            return ret;
            return DASHBOARD_GetOption('Selected Tones')             
        },        
        __GetSearchIntentModel(){
//{% if page == 'ClusterCreator' %}        
            return CLUSTERCREATOR_SETTINGS.GetModelFor('Search Intent') 
//{% endif %} 
            return DASHBOARD_GetModel('Search Intent')               
        },
        __GetCleanUpModel(){
//{% if page == 'ClusterCreator' %}        
            return CLUSTERCREATOR_SETTINGS.GetModelFor('Outline Cleaning') 
//{% endif %} 
            return DASHBOARD_GetModel('Outline Cleaning')               
        },
        GetModel(){
//{% if page == 'ClusterCreator' %}        
            return CLUSTERCREATOR_SETTINGS.GetModelFor('Outline Generation') 
//{% endif %} 
            return DASHBOARD_GetModel('Outline Generation')            
        },
        GetKeyword(){return this.__CurrentKeyword;},
        SelectURLs(selection){            
            //console.log(selection)
            for (const url of this.__URLs) {                
                url.checkbox.checked = selection.includes(url.URL) ? true : false;  
            }               
        },
        InsertURL : function(url) {
            var truncated   = DASHBOARD_TruncateString(url);
            var container   = document.getElementById('OUTLINEGEN::URLs-Column');
            var label       = document.createElement('label');
            var input       = document.createElement('input');
            var span        = document.createElement('span');
            label.classList = 'ckbox DASHBOARD_CheckboxLabel DASHBOARD_ellipsis';
            input.className = 'checkbox';
            input.type      = 'checkbox'
            input.checked   = true;
            span.innerHTML  = truncated;
            span.className  = 'DASHBOARD_ellipsis'
            label.appendChild(input);
            label.appendChild(span);
            container.appendChild(label);      
            this.__URLs.push({
                short_url     : truncated,
                URL           : url,
                checkbox      : input,
                label         : label,
                outline       : '',
                OutlineWidget : null
            });
            var _this = this;
            input.onchange = function(event) {
                if (_this.GetKeyword() !== null)
                _this.GetKeyword().OutlineWidgetProgress_UpdateURLSelection(url, input.checked)
            }                      
        },  
        GetURL(to_find){
            for (url of this.__URLs) {
                if (url.URL === to_find || url.short_url === to_find){
                    return url
                }
            }
        },
        RemoveWidget(widget){
            if (this.GetKeyword() != null) this.GetKeyword().OutlineWidgetProgress_DiscardOutline(this.GetURL(widget.src_url).URL)

            this.GetURL(widget.src_url).OutlineWidget = null;
            this.GetURL(widget.src_url).outline       = '';
            widget.column.parentElement.removeChild(widget.column);
        },
        URLClicked  : function(src){     
            window.open(this.GetURL(src.innerHTML).URL);              
        }, 
        MouseOverURL : function(src){                
            var url = this.GetURL(src.innerHTML);                
            document.getElementById('OUTLINEGEN::outline_view').value = url.outline; 
            document.getElementById('OUTLINEGEN::url_link').innerHTML = url.short_url;                                  
        },      
        ClearURLs : function() {
            for (url of this.__URLs) {
                if (url.OutlineWidget != null){
                    this.RemoveWidget(url.OutlineWidget);
                }                
                url.label.parentElement.removeChild(url.label);     
            }
            this.__URLs = [];           
        }, 
        AppendOutline : function(url, outline){
            if (url.OutlineWidget != null){
                this.RemoveWidget(url.OutlineWidget);
            }                
            url.OutlineWidget = OutlineGen_OutlineWidget(url.URL, url.outline, document.getElementById('OUTLINEGEN::outlines-div'));
        } ,         
        AScrape : async function() {                     
            var fetch_data = {URLs : []}  
            for (url of this.__URLs) {
                if (url.checkbox.checked == 1){
                    fetch_data.URLs.push(url.URL);                        
                }
            } 
            //console.log(fetch_data.URLs);                   
            var fetch_options  = DASHBOARD_FetchOPtions()  
            fetch_options.body =  JSON.stringify(fetch_data);                    
            var outlines       = await DASHBOARD_Fetch('/outlinegen-scrape', fetch_options); 
            this.ScrapeFinished(outlines)           
        },
        ACleanUP_All : async function() {   
            let prompts     = this.__GetCleanUPPrompts();
            if (prompts == null){
                alert("No cleaup prompts defined");
                return;
            }
            var fetch_body  = {Model : this.__GetCleanUpModel(), System : prompts.System, User : prompts.User};
            var keywords    = KEYWORDS.ListKeywordsNames()
            var kword       = null;
            for (const keyword of keywords){
                kword = KEYWORDS.GetKeyWord(keyword);               
                if (kword === null) continue;
                if (kword.OutlineWidgetProgress_HasOutlines() == null)  continue;
                let outline = kword.OutlineWidgetProgress_HasOutlines().URLs
                fetch_body[keyword] = []
                for (const outline of kword.OutlineWidgetProgress_HasOutlines().URLs){
                    fetch_body[keyword].push({url : outline.URL, outline : outline.Outline})
                }
            }
            var fetch_options  = DASHBOARD_FetchOPtions()  
            fetch_options.body =  JSON.stringify(fetch_body);                    
            var outlines       = await DASHBOARD_Fetch('/outlinegen-clean-up-all', fetch_options);  
            for (const [key, value] of Object.entries(outlines)){
                var keyword = KEYWORDS.GetKeyWord(key);
                if (keyword == null) continue;                
                keyword.OutlineWidgetProgress_SetOutlines(value)
            }  
            OutlineGen.SetKeyword(KEYWORDS.Get1st())
            OutlineGen_SetMsg('')               
        },
        CleanUP_All(){
            OutlineGen_SetMsg('Cleaning up outlines');     
            this.ACleanUP_All();
        },
        ACleanUP : async function() {   
            let prompts     = this.__GetCleanUPPrompts();
            if (prompts == null){
                alert("No cleaup prompts defined");
                return
            }
            let kword         = document.getElementById('OUTLINEGEN::Keyword').value;
            let fetch_body    = {Model : this.__GetCleanUpModel(), System : prompts.System, User : prompts.User};
            fetch_body[kword] = [];
            for (const url of this.__URLs) {
                if (url.OutlineWidget === null) continue;
                fetch_body[kword].push({url : url.URL, outline : url.outline})   
            }        
            
            let fetch_options  = DASHBOARD_FetchOPtions()  
            fetch_options.body = JSON.stringify(fetch_body);                    
            let outlines       = await DASHBOARD_Fetch('/outlinegen-clean-up-all', fetch_options);            
            for (const outline of outlines[kword].URLs){
                this.GetURL(outline.URL).outline                  = outline.Outline;     
                this.GetURL(outline.URL).OutlineWidget.text.value = outline.Outline;               
            }         
            if (OutlineGen.GetKeyword() != null) OutlineGen.GetKeyword().OutlineWidgetProgress_SetOutlines(outlines[kword]);   
            OutlineGen_SetMsg('');                      
        },
        CleanUP(){
            OutlineGen_SetMsg('Cleaning up outline');     
            this.ACleanUP();
        },
        ScrapeFinished(outlines){
            for (outline of outlines.URLs){
                if (this.GetURL(outline.URL).OutlineWidget != null)
                this.RemoveWidget(this.GetURL(outline.URL).OutlineWidget);
                if (outline.Outline !== '') {
                    this.GetURL(outline.URL).outline = outline.Outline;
                    this.AppendOutline(this.GetURL(outline.URL), outline);
                }
            }                
            OutlineGen_SetMsg('');
            //{% if page == 'ClusterCreator' %}   
            document.getElementById('OUTLINEGEN::clean-up-button').disabled    = false;              
            document.getElementById('OUTLINEGEN::improve-button-all').disabled = false;     
            //{% endif %}              
            document.getElementById('OUTLINEGEN::clean-up-single-button').disabled = false;                   
            document.getElementById('OUTLINEGEN::gen-button').disabled             = false;      
            document.getElementById('OUTLINEGEN::improve-button').disabled         = false;           
            if (OutlineGen.GetKeyword() != null) OutlineGen.GetKeyword().OutlineWidgetProgress_SetOutlines(outlines);                  
        },
        Scrape : function() {
            OutlineGen_SetMsg('Scraping URLs');     
            this.AScrape();
        },
        AScrape_All : async function() {      
            await DASHBOARD_UpdateSettings()
            var fetch_body  = {};
            var keywords    = KEYWORDS.ListKeywordsNames()
            var kword       = null;
            for (const keyword of keywords){
                kword = KEYWORDS.GetKeyWord(keyword);               
                if (kword === null) continue;
                if (kword.OutlineWidgetProgress_HasOutlines() &&  (false == CLUSTERCREATOR_SETTINGS.OverWrite())) continue
                if (kword.OutlineWidgetProgress_HasURLs() == null)  continue;
                fetch_body[keyword] = [];
                for (const selection of kword.OutlineWidgetProgress_GetSelection()){
                    fetch_body[keyword].push(selection)
                }
            }
            
            var fetch_options  = DASHBOARD_FetchOPtions()  
            fetch_options.body =  JSON.stringify(fetch_body);                    
            var outlines       = await DASHBOARD_Fetch('/outlinegen-scrape-all', fetch_options);  
            
            for (const [key, value] of Object.entries(outlines)){
                var keyword = KEYWORDS.GetKeyWord(key);
                if (keyword == null) continue;                
                keyword.OutlineWidgetProgress_SetOutlines(value)
            }  
            OutlineGen.SetKeyword(KEYWORDS.Get1st())
            OutlineGen_SetMsg('')  
        },
        Scrape_All : function() {
            OutlineGen_SetMsg('Scraping URLs for all Keywords');     
            this.AScrape_All();
        },
        SetIntent : function(intent){
            this.__SeachIntent = intent;
        },
        AGenerate : async function(){            
            var outlines = []
            for (url of this.__URLs){
                if (url.outline != '') {
                    outlines.push(url.OutlineWidget.text.value);
                }
            }
            var fetch_options  = DASHBOARD_FetchOPtions()  
            fetch_options.body = JSON.stringify({
                Model       : this.GetModel(),
                Outlines    : outlines, 
                SeachIntent : this.__SeachIntent, 
                Keyword     : document.getElementById('OUTLINEGEN::Keyword').value
            });    
            var outline = await DASHBOARD_Fetch('/outlinegen-generate', fetch_options); 
            this.GenerateFinished(outline)          
        },
        GenerateFinished(outline){
            OutlineGen_SetMsg('')   
            document.getElementById('OUTLINEGEN::result-view').value             = outline.Outline;
            document.getElementById('OUTLINEGEN::result').style.visibility       = 'visible';            
            if (OutlineGen.GetKeyword() != null) OutlineGen.GetKeyword().OutlineWidgetProgress_SetOutline(outline);    
        },
        Generate : function(){           
            OutlineGen_SetMsg('Generating outline'); 
            this.AGenerate();
        },
        AOptimize : async function(){
            await DASHBOARD_UpdateSettings()
            await DASHBOARD_Fetch('content_creator-get_blacklisted_words?list=Outlines', DASHBOARD_FetchOPtions());     
            console.log('GetSemanticAnalysis');
            try {
                console.log(this.GetKeyword().GetSemanticAnalysis());
            } catch (err){
                alert(`Error parsing the Entity analysis: ${err}`)
                return;
            }
            var outlines = []
            for (url of this.__URLs){
                if (url.outline != '') {
                    outlines.push(url.OutlineWidget.text.value);
                }
            }
            var fetch_options  = DASHBOARD_FetchOPtions()  
            fetch_options.body = JSON.stringify({
                Country          : document.getElementById('OUTLINEGEN::Country').value,  
                IntentModel      : OutlineGen.__GetSearchIntentModel(),    
                Model            : this.GetModel(),
                Model2ndPass     : DASHBOARD_GetModel('outline-black-list-2nd'), 
                Outlines         : outlines, 
                SeachIntent      : this.GetKeyword().GetIntent(),  //this.__SeachIntent, 
                Keyword          : document.getElementById('OUTLINEGEN::Keyword').value,
                Tones            : this.__GetTones(),
                Audience         : this.__GetAudience(),
                SemanticAnalisys : this.GetKeyword().GetSemanticAnalysis(),
                Facts            : this.GetKeyword().GetFacts(),
                FixOutline       : DASHBOARD_OptionB('Fix Outlines'),
                FixModel         : DASHBOARD_GetModel('outline-black-list'),
                'Prompts'        : await OUTLINEGEN_GetPrompts(),
                'SpecialInstructions' : document.getElementById('OUTLINEGEN::special-instructions').value
            });    
            var outline = await DASHBOARD_Fetch('/outlinegen-generate-optimized', fetch_options); 
            this.GenerateFinished(outline)    
        },
        Optimize  : function(){        
            if (this.__GetAudience()     == '') return alert('No audience selected');
            if (this.__GetTones().length == 0)  return alert('No tones selected');
            
            OutlineGen_SetMsg('Generating semantic optimized outline'); 
//{% if page == 'ClusterCreator' %}    
            this.AOptimize(); 
//{% else %}              
            this.AGenerate()
//{% endif %}              
        },
        AOptimize_All : async function(){
            await DASHBOARD_UpdateSettings()
            await DASHBOARD_Fetch('content_creator-get_blacklisted_words?list=Outlines', DASHBOARD_FetchOPtions());     
            var query       = []
            var keywords    = KEYWORDS.ListKeywordsNames()
            var kword       = null;
            for (const keyword of keywords){
                kword = KEYWORDS.GetKeyWord(keyword);   
                if (kword.OutlineWidgetProgress_HasOutline() && (false == CLUSTERCREATOR_SETTINGS.OverWrite())) continue            
                if (kword === null) continue;
                if (kword.OutlineWidgetProgress_HasOutlines() === null){
                    //OutlineGen_SetMsg(`Keyword ${keyword} skiped because is has no Outlines`, '...'); 
                    //continue
                    OutlineGen_SetMsg(`Keyword ${keyword} has no Outlines`, '...'); 
                }
                try {kword.GetSemanticAnalysis()}
                catch(err){
                    OutlineGen_SetMsg(`Keyword ${keyword} skiped. Error when parsing samantic analysis? ${err}`, '...'); 
                    continue        
                }
                query.push({
                    Model            : this.GetModel(),
                    Model2ndPass     : DASHBOARD_GetModel('outline-black-list-2nd'), 
                    Outlines         : kword.GetOutlines(), 
                    SeachIntent      : kword.GetIntent(), 
                    Keyword          : kword.GetKeyWord(),
                    Tones            : this.__GetTones(),
                    Audience         : this.__GetAudience(),
                    SemanticAnalisys : kword.GetSemanticAnalysis(),
                    Facts            : kword.GetFacts(),                    
                })
            }  
            console.log(query);     
            var fetch_options  = DASHBOARD_FetchOPtions()  
            fetch_options.body = JSON.stringify({
                'Query'       : query, 
                'FixModel'    : DASHBOARD_GetModel('outline-black-list'), 
                'FixOutlines' : DASHBOARD_OptionB('Fix Outlines'),
                'Prompts'     : await OUTLINEGEN_GetPrompts(),
                'SpecialInstructions' : document.getElementById('OUTLINEGEN::special-instructions').value
            });      
            var outlines       = await DASHBOARD_Fetch('/outlinegen-generate-optimized-all', fetch_options); 
            for (const outline of outlines.Reply){
                console.log(outline)
                kword = KEYWORDS.GetKeyWord(outline.Keyword)
                if (kword === null) continue;
                console.log(outline)
                kword.OutlineWidgetProgress_SetOutline({Outline : outline.Outline, SearchIntent : outline.SearchIntent})
            }
            OutlineGen_SetMsg('');  
            OutlineGen.SetKeyword(KEYWORDS.Get1st())
        },       
        Optimize_All(){
            if (this.__GetAudience()     == '') return alert('No audience selected');
            if (this.__GetTones().length == 0)  return alert('No tones selected');
            
            OutlineGen_SetMsg('Generating semantic optimized outlines'); 
            this.AOptimize_All();
        },
        Export : function () {
            var outline =  document.getElementById('OUTLINEGEN::result-view').value;
            navigator.clipboard.writeText(outline); 
            alert('Outline copyed to clipboard: ');
        },
        async InitWidgets(){
            this.__TonesIdsList     = [];
            this.__AudiencesIdsList = [];;
            var src       = document.getElementById('OUTLINEGEN::tone-template');
            var container = document.getElementById('OUTLINEGEN::tones-container');

            var fetch_options = DASHBOARD_FetchOPtions()              
            var tones         = await DASHBOARD_Fetch('/outlinegen-get-tones', fetch_options);  
            this.__Tones      = tones;
            for (const tone of tones.Tones) {
                let clone                   = src.content.cloneNode(true);    
                clone.children[0].id        = `OUTLINEGEN::tone-${tone.Tone.replace(" ", "-")}`;
                clone.children[0].innerHTML = tone.Tone;
                clone.children[0].value     = tone.Tone;
                this.__TonesIdsList.push(clone.children[0].id)
                container.appendChild(clone);
            }
            var src       = document.getElementById('OUTLINEGEN::audience-template');
            var container = document.getElementById('OUTLINEGEN::audiences-container');
            for (const audience of tones.Audiences) {
                let clone                   = src.content.cloneNode(true);  
                clone.children[0].id        = `OUTLINEGEN::audience-${audience.Audience.replace(" ", "-")}`; 
                clone.children[0].innerHTML = audience.Audience;         
                clone.children[0].value     = audience.Audience;
                this.__AudiencesIdsList.push(clone.children[0].id )
                container.appendChild(clone);
            }
            document.getElementById('OUTLINEGEN::Keyword').onchange = function(){
                OutlineGen.SetKeyword(null);
                OutlineGen.ClearURLs();
                OutlineGen.SetKeyword(KEYWORDS.GetKeyWord(this.value));
            }
            document.getElementById('OUTLINEGEN::sertp-all').disabled = false;
        },
        GetTones(){
            var tones = []
            var slct  = document.getElementById('OUTLINEGEN::tones-container') ;                
            for (option of slct.options) {
                if (option.selected) {
                    tones.push(option.value)
                }
            }
            return tones
        },
        GetAudience(){            
            var slct  = document.getElementById('OUTLINEGEN::audiences-container') ;                
            for (option of slct.options) {
                if (option.selected) {
                    return option.value
                }
            }
            return ''
        },
        ToneChanged(){     
            var slct = document.getElementById('OUTLINEGEN::tones-container') ;
            count    = 0;     
            for (option of slct.options) {
                if (option.selected) {
                    count += 1
                    if (count > 2){
                        option.selected = false;
                        alert('Select only two')
                        return;
                    }
                }
            }            
        },
        AudienceChanged(src){            
            var slct = document.getElementById('OUTLINEGEN::audiences-container') ;
            count    = 0;     
            for (option of slct.options) {
                if (option.selected) {
                    count += 1
                    if (count > 1){
                        option.selected = false;
                        alert('Select only one')
                        return;
                    }
                }
            }   
        },
        ShowToneTip(src){
            var key = src.id.replace('OUTLINEGEN::tone-', '').replace('-', ' ')           
            var tip = '';
            for (tone of this.__Tones.Tones){
                if (tone.Tone === key)
                tip = `<b>${key}:</b><br>${tone.Caption}`;
            }            
            document.getElementById('OUTLINEGEN::tone-tip').innerHTML     = tip;
            document.getElementById('OUTLINEGEN::tone-tip').style.display = 'block'
        } ,   
        ShowAudienceTip(src){
            var key = src.id.replace('OUTLINEGEN::audience-', '').replace('-', ' ')           
            var tip = '';
            for (audience of this.__Tones.Audiences){
                if (audience.Audience === key)
                tip = `<b>${key}:</b><br>${audience.Caption}`;
            }                
            document.getElementById('OUTLINEGEN::audience-tip').innerHTML     = tip;
            document.getElementById('OUTLINEGEN::audience-tip').style.display = 'block'
        }       
    }
    function OutlineGen_OutlineWidget(url, outline, parent_div){
        var widget  = {
            column   : document.createElement('div'),     
            row      : document.createElement('div'), 
            url      : document.createElement('p'),  
            full_url : document.createElement('div'), 
            text     : document.createElement('textarea'),  
            button   : document.createElement('button'),  
            spacer   : document.createElement('div'),   
            src_url  : url         
        }
        widget.column.style           = 'display:flex; flex-direction:column; gap:4px; position:relative';
        widget.row.style              = 'display:flex;flex-direction:row-reverse';
        widget.text.style             = 'min-width:520px; min-height:300px; width:400px; height:300px;'
        widget.url.style              = 'min-width:520px; width:400px; height:18px;'
        widget.url.classList          = 'mg-b-20 DASHBOARD_ClicableText'
        widget.text.classList         = 'form-control'        
        widget.spacer.style           = 'min-width:380px'   
        widget.text.value             = outline;
        widget.url.innerHTML          = DASHBOARD_TruncateString(url, max=78);
        widget.full_url.innerHTML     = url;
        widget.full_url.style         = 'position:absolute;display:none;background-color:#6f42c1;color:white;top:40;height:20px';
        widget.url.style              = 'margin-bottom:2px; border:1px solid #cdd4e0; padding: 8px 10px; background-color: #f4f5f8';
        widget.button.innerHTML       = 'Remove';
        widget.button.classList       = 'btn btn-danger btn-rounded';
        parent_div.appendChild(widget.column);       
        widget.row.appendChild(widget.button);
        widget.column.appendChild(widget.url);
        widget.column.appendChild(widget.full_url);
        widget.column.appendChild(widget.text);
        widget.column.appendChild(widget.row);            
        widget.url.onclick     = function(){widget.UrlClicked();}
        widget.button.onclick  = function(){OutlineGen.RemoveWidget(widget)}

        widget.url.onmouseenter = function(){widget.full_url.style.display='flex'}
        widget.url.onmouseleave = function(){widget.full_url.style.display='none'}

        widget.UrlClicked = function(){
            window.open(OutlineGen.GetURL(this.src_url).URL);
        }       
        widget.text.onkeypress = function(){
            var kword = OutlineGen.GetKeyword();            
            if (kword === null) return;
            kword.OutlineWidgetProgress_OutlineChanged(widget.src_url, widget.text.value);
        }       
        widget.text.onchange = widget.text.onkeypress;
        return widget;
    }
    function OutlineGen_SetMsg(msg) {
        document.getElementById('OUTLINEGEN::msg').innerHTML         = msg;
        document.getElementById('OUTLINEGEN::spinner').style.display = msg === '' ? 'None' : 'block';
    }  
    async function OutlineGen_ASERP() {                  
        const model    = OutlineGen.__GetSearchIntentModel();
        const country  = document.getElementById('OUTLINEGEN::Country').value;
        const kword    = document.getElementById('OUTLINEGEN::Keyword').value;
        const options  = {method : 'POST', headers : {'Content-Type': 'application/json', 'Accept' : 'application/json'}};                
        var  urls      = await DASHBOARD_Fetch(`/outlinegen-serp?country_code=${country}&keyword=${kword}&model=${model}`, options);                     
        if ('err' in urls) {
            //console.log(urls)
            return
        };                     
        OutlineGen_SERPDone(urls)       
    }  
    function OutlineGen_SERPDone(data){
        OutlineGen.ClearURLs(); 
        for (const url of data.URLs) {                
            OutlineGen.InsertURL(url);                             
        }     
        OutlineGen.SetIntent(data.intent);
        OutlineGen_SetMsg('');   
        document.getElementById('OUTLINEGEN::scrape').disabled         = false;
        document.getElementById('OUTLINEGEN::improve-button').disabled = false;
//{% if page == 'ClusterCreator' %}              
        document.getElementById('OUTLINEGEN::scrape-all').disabled         = false;
        document.getElementById('OUTLINEGEN::improve-button-all').disabled = false;
//{% endif %}              
        if (OutlineGen.GetKeyword() != null) OutlineGen.GetKeyword().OutlineWidgetProgress_Reset()  
        if (OutlineGen.GetKeyword() != null) OutlineGen.GetKeyword().OutlineWidgetProgress_SetURL(data)        
    }  
    function OutlineGen_SERP(){        
        OutlineGen_SetMsg(' Generating top-ranking articles list and performing search intent analysis')  
        OutlineGen_ASERP(); 
        OUTLINEGEN_ResetView()          
    }  
    function OUTLINEGEN_ResetView(){  
        document.getElementById(`OUTLINEGEN::result-view`).value = ''; 
        for (const el_id of 'improve-button improve-button-all gen-button sertp-all clean-up-button scrape scrape-all clean-up-single-button'.split(' ')){
            console.log()
            document.getElementById(`OUTLINEGEN::${el_id}`).disabled = true;
        }
    //{% if page == 'ClusterCreator' %}            
        document.getElementById(`OUTLINEGEN::sertp-all`).disabled = false;
    //{% endif %}              
        //document.getElementById('OUTLINEGEN::gen-button').style.visibility          = 'hidden';        
        //document.getElementById('OUTLINEGEN::outlines-subtitle').style.visibility   = 'hidden';     
        //document.getElementById('OUTLINEGEN::URLs-Row').style.visibility            = 'hidden';            
        //document.getElementById('OUTLINEGEN::result').style.visibility              = 'hidden';
    }
    function OUTLINEGEN_ImportKeywords(current=null){
        var kwords_select       = document.getElementById('OUTLINEGEN::Keyword');
        kwords_select.innerHTML = ''
        console.log(KEYWORDS.ListKeywordsNames())
        for (const name of KEYWORDS.ListKeywordsNames()){
            var option       = document.createElement('option');
            option.value     = name;
            option.innerHTML = name;
            kwords_select.appendChild(option);
        }
        OUTLINEGEN_ResetView()
        if (current === null) current = KEYWORDS.Get1st();
        if (current !== null) {
            kwords_select.value = current.GetKeyword();
            OutlineGen.SetKeyword(current)
        }        
    }  
    async function OutlineGen_ASERPAll(){
        await DASHBOARD_UpdateSettings()
        var keywords       = []; 
        for (const name of KEYWORDS.ListKeywordsNames()){
            if (KEYWORDS.GetKeyWord(name).OutlineWidgetProgress_HasURLs() && (false == CLUSTERCREATOR_SETTINGS.OverWrite())) continue;
            keywords.push(name)
        }
        const model        = OutlineGen.__GetSearchIntentModel();
        const country      = document.getElementById('OUTLINEGEN::Country').value;       
        var fetch_data     = {CountryCode : country, Keywords : keywords, Model : model, Prompts : await OUTLINEGEN_GetPrompts()};                          
        var fetch_options  = DASHBOARD_FetchOPtions()  
        fetch_options.body = JSON.stringify(fetch_data);                    
        var replys         = await DASHBOARD_Fetch('/outlinegen-serp-all', fetch_options); 
        //console.log(replys.Reply)       
        var kword = null; 
        for (const reply of replys.Reply){            
            kword = KEYWORDS.GetKeyWord(reply.Keyword)
            if (kword == null) continue;
            kword.OutlineWidgetProgress_SetURL(reply)
        }
        OutlineGen.SetKeyword(KEYWORDS.Get1st())
        OutlineGen_SetMsg('')  
    }    
    function OutlineGen_SERPAll(){
        OutlineGen_SetMsg(' Generating top-ranking articles list and performing search intent analysis for all keywords')  
        return OutlineGen_ASERPAll()
    }
    document.getElementById('OUTLINEGEN::result-view').onkeydown = function(){
        if (OutlineGen.GetKeyword() != null) OutlineGen.GetKeyword().OutlineWidgetProgress_SetOutline({'Outline' : 
            document.getElementById('OUTLINEGEN::result-view').value
        });      
    }
    document.getElementById('OUTLINEGEN::result-view').onchange = function(){
        if (OutlineGen.GetKeyword() != null) OutlineGen.GetKeyword().OutlineWidgetProgress_SetOutline({'Outline' : 
            document.getElementById('OUTLINEGEN::result-view').value
        });      
    }
//{% if page == 'ClusterCreator' %}        
    OutlineGen.InitWidgets();    
//{% endif %}         
    async function OUTLINEGEN_PopulateModels(){   
        var reply  = await DASHBOARD_Fetch('https://openrouter.ai/api/v1/models');            
        let select       = document.getElementById('OUTLINEGEN::model');
        select.innerHTML = ''
        for (const model of reply.data){
            let option   = document.createElement('option');
            option.value = model.id;
            option.label = model.name;
            if (model.id === 'openai/gpt-4-turbo-preview')
            option.selected = true;
            select.appendChild(option);
        }  
        await DASHBOARD_UpdateSettings()  
        select           = document.getElementById('OUTLINEGEN::prompts')
        select.innerHTML = ''        
        for (const prompt in DASHBOARD_OptionO('More Prompts')['Outlines']){            
            let option      = document.createElement('option');
            option.value    = prompt;
            option.label    = prompt;              
            select.appendChild(option);
        }              
    }
    OUTLINEGEN_PopulateModels()
    async function OUTLINEGEN_GetPrompts(){
        await DASHBOARD_UpdateSettings()
        let date      = new Date().toDateString().split(' ').slice(1, 4).toString().replace(',', ' ').replace(',', ', ');
        let templates = 
        DASHBOARD_OptionO('More Prompts')['Outlines'][document.getElementById('OUTLINEGEN::prompts').value];
        return {'Search Intent' : templates[0].replace('{Date}', date), 'Reserved' : templates[1].replace('{Date}', date), 
        'Outline System' : templates[2].replace('{Date}', date), 'Outline User' : templates[3].replace('{Date}', date)};
    }
    function OutlineGen_GetSectionNumber(head){
    number = head.trim().split(' ')[0];
    for (let char of number){
        if (false === '0123456789.'.includes(char)){
            return '';
        }
    }
    return number
}
    function OutlineGen_GetLevel(head){
        let h     = head.replaceAll('\t', '    ');
        let count = 0;
        for (let char of h){
            if (char == ' '){
                count += 1;
            }
            else break
        }
        return count
    }

    function OutlineGen_IncreseIndex(index){    
        try {
            let i     = index.trim().split('.')
            let last  = i.at(-2);        
            i[i.length - 2]  = parseInt(last) + 1;
            return i.join('.')
        } catch (e) {
            return index;
        }    
    }

    function OutlineGen_IncreseLevel(index){    
        return index + '1.'
    }

    function GeneneralFixes(outline){       
        return result = outline.replace(/^\[Note:.*$/gm, '');        
    }

    function FixSectionNumbers(text) {
        if (text.includes('\nIntroduction\n')){
            try {
                text = '\nIntroduction\n' + text.split('\nIntroduction\n')[1]
            }catch(e){}
        }
        let lines     = text.split('\n');    
        let new_lines = []
        let faq_flag  = false
        for (let [i, line] of lines.entries()) {      
            try {            
                if (line.split(' ').slice(1).join(' ') === 'Frequently Asked Questions') {
                    faq_flag = true;
                }
            } catch (e) {}        
            if (i === 0 || faq_flag === true) {
                new_lines.push( lines[i] )
                continue
            }    
            if (line.trim().startsWith('-')) {
                let last_section = OutlineGen_GetSectionNumber(new_lines[i-1])
                if (last_section === '') {
                    new_lines.push( lines[i]  )
                    continue
                }
                let curr_level   = OutlineGen_GetLevel(lines[i])
                let prev_level   = OutlineGen_GetLevel(lines[i-1])
                if (curr_level == prev_level)
                    new_lines.push( lines[i].replace('-', OutlineGen_IncreseIndex(last_section)) )
                else if (curr_level > prev_level)
                    new_lines.push( lines[i].replace('-', OutlineGen_IncreseLevel(last_section)) )
                else
                    new_lines.push( lines[i] )
            }
            else 
                new_lines.push( lines[i]  )
        }
        try{
            return GeneneralFixes(new_lines.join('\n').slie(0, -1))
        }catch(e){
            return GeneneralFixes(new_lines.join('\n'))
        }
    }
 
    function OutlineGen_FixOutLine(){           
        document.getElementById('OUTLINEGEN::result-view').value = FixSectionNumbers(document.getElementById('OUTLINEGEN::result-view').value);
        document.getElementById('OUTLINEGEN::result-view').onchange();
    } 
</script>    

